{% extends "base.html" %}
{% block title %}Billing Workspace{% endblock %}

{% block content %}
<div
  id="biller-app"
  class="billing-workspace"
  data-initial='{{ initial_unbilled_json|safe }}'
  data-clients='{{ clients_json|safe }}'
  data-selected-client='{{ selected_client_id }}'
>
  <section class="workspace-header">
    <div class="workspace-header__copy">
      <p class="workspace-header__eyebrow">Billing</p>
      <h2 class="workspace-header__title">Invoice Builder</h2>
      <p class="workspace-header__lead">
        Select unbilled time, parts, and flat tasks, then tune rates and quantities to assemble an invoice in one flow.
      </p>
      <p class="workspace-header__selection" data-role="selection-indicator">Showing all clients</p>
    </div>
    <div class="workspace-metrics" aria-live="polite">
      <article class="workspace-metric" data-type="time">
        <span class="workspace-metric__label">Unbilled time</span>
        <div class="workspace-metric__value">
          <strong data-role="metric-time-count">0</strong>
          <span class="workspace-metric__suffix">items</span>
        </div>
        <span class="workspace-metric__total" data-role="metric-time-total">$0.00</span>
      </article>
      <article class="workspace-metric" data-type="parts">
        <span class="workspace-metric__label">Issued parts</span>
        <div class="workspace-metric__value">
          <strong data-role="metric-parts-count">0</strong>
          <span class="workspace-metric__suffix">items</span>
        </div>
        <span class="workspace-metric__total" data-role="metric-parts-total">$0.00</span>
      </article>
      <article class="workspace-metric" data-type="flat">
        <span class="workspace-metric__label">Flat tasks</span>
        <div class="workspace-metric__value">
          <strong data-role="metric-flat-count">0</strong>
          <span class="workspace-metric__suffix">templates</span>
        </div>
        <span class="workspace-metric__total" data-role="metric-flat-total">$0.00</span>
      </article>
    </div>
  </section>

  <div class="biller-grid">
    <section class="biller-pane biller-filters surface surface--raised">
      <header class="pane-head">
        <h3 class="pane-title">Filters</h3>
      </header>
      <form data-role="filters-form" class="filters-form">
        <label class="field-block">
          <span>Client</span>
          <select name="client_id" data-role="client-select">
            <option value="">All clients</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if client.id|string == selected_client_id|string %}selected{% endif %}>
              {{ client.name }}
            </option>
            {% endfor %}
          </select>
        </label>
        <label class="field-block">
          <span>Project</span>
          <select name="project_id" data-role="project-select">
            <option value="">All projects</option>
          </select>
        </label>
        <label class="field-block">
          <span>From</span>
          <input type="date" name="from" data-role="from-date" />
        </label>
        <label class="field-block">
          <span>To</span>
          <input type="date" name="to" data-role="to-date" />
        </label>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Refresh</button>
          <button type="button" class="btn btn-ghost" data-action="clear-filters">Clear filters</button>
        </div>
      </form>
    </section>

    <section class="biller-pane biller-lists surface surface--raised">
      <header class="pane-head">
        <h3 class="pane-title">Unbilled sources</h3>
      </header>
      <div class="tab-bar" role="tablist">
        <button type="button" class="tab-button active" data-role="tab" data-tab="time" role="tab" aria-selected="true">
          Unbilled time
        </button>
        <button type="button" class="tab-button" data-role="tab" data-tab="parts" role="tab" aria-selected="false">
          Parts
        </button>
        <button type="button" class="tab-button" data-role="tab" data-tab="flat" role="tab" aria-selected="false">
          Flat tasks
        </button>
      </div>
      <div class="tab-content">
        <div class="tab-panel" data-list="time" role="tabpanel"></div>
        <div class="tab-panel hidden" data-list="parts" role="tabpanel"></div>
        <div class="tab-panel hidden" data-list="flat" role="tabpanel"></div>
      </div>
    </section>

    <section class="biller-pane biller-invoice surface surface--raised">
      <header class="pane-head pane-head--split">
        <div>
          <h3 class="pane-title">Invoice assembly</h3>
          <p class="pane-subtitle">Tune quantities and rates, then create and finalize invoices without leaving the page.</p>
        </div>
        <div class="invoice-controls-group">
          <label>
            <span>Discount</span>
            <input type="number" step="0.01" value="0.00" data-role="discount-input" />
          </label>
          <label>
            <span>Tax</span>
            <input type="number" step="0.01" value="0.00" data-role="tax-input" />
          </label>
        </div>
      </header>
      <div data-role="invoice-empty" class="empty-state">Select items to build an invoice.</div>
      <div class="invoice-table-wrap">
        <table class="invoice-table" data-role="invoice-table">
          <thead>
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Qty</th>
              <th scope="col">Rate</th>
              <th scope="col">Total</th>
              <th scope="col" class="table-actions">Action</th>
            </tr>
          </thead>
          <tbody data-role="invoice-lines"></tbody>
        </table>
      </div>
      <dl class="invoice-summary">
        <div>
          <dt>Subtotal</dt>
          <dd data-role="subtotal">$0.00</dd>
        </div>
        <div>
          <dt>Total</dt>
          <dd data-role="total">$0.00</dd>
        </div>
      </dl>
      <div class="invoice-actions">
        <button type="button" class="btn btn-primary" data-action="create">Create draft</button>
        <div class="finalize-group hidden" data-role="finalize-group">
          <label>
            <span>Finalize as</span>
            <select data-role="finalize-status">
              <option value="sent">Sent</option>
              <option value="paid">Paid</option>
            </select>
          </label>
          <button type="button" class="btn btn-secondary" data-action="finalize">Finalize</button>
        </div>
        <button type="button" class="btn btn-link" data-action="reset">Reset selection</button>
      </div>
      <p class="status-message" data-role="status-message" role="status" aria-live="polite"></p>
    </section>
  </div>
</div>

<script>
(() => {
  const root = document.getElementById("biller-app");
  if (!root) {
    return;
  }

  const parseJSON = (value, fallback) => {
    try {
      return value ? JSON.parse(value) : fallback;
    } catch {
      return fallback;
    }
  };

  const state = {
    clients: parseJSON(root.dataset.clients, []),
    unbilled: parseJSON(root.dataset.initial, { time: [], parts: [], flat: [] }),
    selectedClientId: root.dataset.selectedClient ? Number(root.dataset.selectedClient) : null,
    filters: { projectId: "", from: "", to: "" },
    activeTab: "time",
    selectedLines: [],
    selectedKeys: new Set(),
    currentInvoice: null,
  };

  const els = {
    tabs: root.querySelectorAll("[data-role='tab']"),
    lists: {
      time: root.querySelector("[data-list='time']"),
      parts: root.querySelector("[data-list='parts']"),
      flat: root.querySelector("[data-list='flat']"),
    },
    panels: root.querySelectorAll(".tab-panel"),
    clientSelect: root.querySelector("[data-role='client-select']"),
    projectSelect: root.querySelector("[data-role='project-select']"),
    fromInput: root.querySelector("[data-role='from-date']"),
    toInput: root.querySelector("[data-role='to-date']"),
    filtersForm: root.querySelector("[data-role='filters-form']"),
    invoiceEmpty: root.querySelector("[data-role='invoice-empty']"),
    invoiceTable: root.querySelector("[data-role='invoice-table']"),
    invoiceLines: root.querySelector("[data-role='invoice-lines']"),
    discountInput: root.querySelector("[data-role='discount-input']"),
    taxInput: root.querySelector("[data-role='tax-input']"),
    subtotal: root.querySelector("[data-role='subtotal']"),
    total: root.querySelector("[data-role='total']"),
    createButton: root.querySelector("[data-action='create']"),
    finalizeGroup: root.querySelector("[data-role='finalize-group']"),
    finalizeButton: root.querySelector("[data-action='finalize']"),
    finalizeStatus: root.querySelector("[data-role='finalize-status']"),
    resetButton: root.querySelector("[data-action='reset']"),
    statusMessage: root.querySelector("[data-role='status-message']"),
    selectionIndicator: root.querySelector("[data-role='selection-indicator']"),
    clearFiltersButton: root.querySelector("[data-action='clear-filters']"),
    metrics: {
      timeCount: root.querySelector("[data-role='metric-time-count']"),
      timeTotal: root.querySelector("[data-role='metric-time-total']"),
      partsCount: root.querySelector("[data-role='metric-parts-count']"),
      partsTotal: root.querySelector("[data-role='metric-parts-total']"),
      flatCount: root.querySelector("[data-role='metric-flat-count']"),
      flatTotal: root.querySelector("[data-role='metric-flat-total']"),
    },
  };

  const formatCurrency = (value) => {
    const number = Number(value) || 0;
    return `$${number.toFixed(2)}`;
  };

  const toNumber = (value) => {
    if (typeof value === "number") {
      return Number.isFinite(value) ? value : 0;
    }
    const parsed = parseFloat(value);
    return Number.isFinite(parsed) ? parsed : 0;
  };

  const updateSelectionIndicator = () => {
    if (!els.selectionIndicator) {
      return;
    }
    if (!state.selectedClientId) {
      els.selectionIndicator.textContent = "Showing all clients";
      return;
    }
    const match = state.clients.find((client) => Number(client.id) === Number(state.selectedClientId));
    els.selectionIndicator.textContent = match ? `Focused on ${match.name}` : "Showing all clients";
  };

  const updateProjectOptions = () => {
    const projectMap = new Map();
    ["time", "parts"].forEach((type) => {
      const items = state.unbilled[type] || [];
      for (const item of items) {
        if (item.project_id) {
          const label = item.work_order_title ? `${item.work_order_title} (#${item.project_id})` : `Project #${item.project_id}`;
          projectMap.set(item.project_id, label);
        }
      }
    });
    const select = els.projectSelect;
    const current = select.value;
    select.innerHTML = '<option value="">All projects</option>';
    for (const [id, label] of projectMap.entries()) {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = label;
      if (current && Number(current) === Number(id)) {
        option.selected = true;
      }
      select.appendChild(option);
    }
  };

  const applyFilters = (type) => {
    const items = state.unbilled[type] || [];
    const { projectId, from, to } = state.filters;
    const fromDate = from ? new Date(from) : null;
    const toDate = to ? new Date(to) : null;

    return items.filter((item) => {
      if (projectId && Number(item.project_id || 0) !== Number(projectId)) {
        return false;
      }
      if (fromDate || toDate) {
        let reference = null;
        if (type === "time") {
          reference = item.ended_at || item.started_at;
        } else if (type === "parts") {
          reference = item.created_at;
        }
        if (reference) {
          const ref = new Date(reference);
          if (fromDate && ref < new Date(fromDate.toDateString())) {
            return false;
          }
          if (toDate) {
            const endOfDay = new Date(toDate);
            endOfDay.setHours(23, 59, 59, 999);
            if (ref > endOfDay) {
              return false;
            }
          }
        }
      }
      return true;
    });
  };

  const updateMetrics = (filteredLists) => {
    const lists = filteredLists || {
      time: applyFilters("time"),
      parts: applyFilters("parts"),
      flat: applyFilters("flat"),
    };
    const { metrics } = els;
    if (!metrics) {
      return;
    }
    if (metrics.timeCount) {
      metrics.timeCount.textContent = lists.time.length;
    }
    if (metrics.timeTotal) {
      const total = lists.time.reduce((sum, item) => sum + toNumber(item.subtotal), 0);
      metrics.timeTotal.textContent = formatCurrency(total);
    }
    if (metrics.partsCount) {
      metrics.partsCount.textContent = lists.parts.length;
    }
    if (metrics.partsTotal) {
      const total = lists.parts.reduce((sum, item) => sum + toNumber(item.subtotal), 0);
      metrics.partsTotal.textContent = formatCurrency(total);
    }
    if (metrics.flatCount) {
      metrics.flatCount.textContent = lists.flat.length;
    }
    if (metrics.flatTotal) {
      const total = lists.flat.reduce((sum, item) => sum + toNumber(item.sell_price), 0);
      metrics.flatTotal.textContent = formatCurrency(total);
    }
  };

  const itemKey = (type, item) => {
    const sourceType = item?.source_type || type;
    const rawId =
      item?.source_id ??
      item?.id ??
      item?.time_entry_id ??
      item?.part_usage_id ??
      item?.catalog_item_id ??
      item?.ticket_id ??
      "";
    return `${sourceType}:${rawId}`;
  };

  const isSelected = (type, item) => {
    const key = itemKey(type, item);
    return key ? state.selectedKeys.has(key) : false;
  };

  const renderList = (type, filteredItems) => {
    const container = els.lists[type];
    if (!container) {
      return;
    }
    container.innerHTML = "";

    const items = filteredItems ?? applyFilters(type);
    if (!items.length) {
      const empty = document.createElement("p");
      empty.className = "empty-state";
      empty.textContent = "No items match the current filters.";
      container.appendChild(empty);
      return;
    }

    for (const item of items) {
      const card = document.createElement("article");
      card.className = "list-card";
      const header = document.createElement("header");
      header.className = "list-card__head";
      const title = document.createElement("h4");
      title.className = "list-card__title";
      const button = document.createElement("button");
      button.type = "button";
      button.className = "btn btn-secondary";
      const bodyElements = [];

      if (type === "time") {
        title.textContent = item.description || `Time Entry #${item.time_entry_id}`;
        const details = document.createElement("p");
        details.className = "list-card__meta";
        const hours = (Number(item.minutes) || 0) / 60;
        const workOrderLabel = item.work_order_id ? ` - Work Order #${item.work_order_id}` : "";
        details.textContent = `${hours.toFixed(2)} hours @ ${formatCurrency(item.resolved_bill_rate)}${workOrderLabel}`;
        bodyElements.push(details);
        if (item.client_name) {
          const client = document.createElement("p");
          client.className = "list-card__client";
          client.textContent = item.client_name;
          bodyElements.push(client);
        }
        if (item.ended_at) {
          const meta = document.createElement("p");
          meta.className = "list-card__time";
          const ended = new Date(item.ended_at);
          meta.textContent = `Ended ${ended.toLocaleString()}`;
          bodyElements.push(meta);
        }
      } else if (type === "parts") {
        title.textContent = `${item.name} (${item.sku})`;
        const details = document.createElement("p");
        details.className = "list-card__meta";
        const workOrderLabel = item.work_order_id ? ` - Work Order #${item.work_order_id}` : "";
        details.textContent = `${Number(item.qty).toFixed(2)} ${item.unit} @ ${formatCurrency(item.resolved_sell_price)}${workOrderLabel}`;
        bodyElements.push(details);
        if (item.client_name) {
          const client = document.createElement("p");
          client.className = "list-card__client";
          client.textContent = item.client_name;
          bodyElements.push(client);
        }
        if (item.created_at) {
          const meta = document.createElement("p");
          meta.className = "list-card__time";
          const created = new Date(item.created_at);
          meta.textContent = `Issued ${created.toLocaleString()}`;
          bodyElements.push(meta);
        }
      } else {
        title.textContent = `${item.name} (${item.sku})`;
        const details = document.createElement("p");
        details.className = "list-card__meta";
        details.textContent = `${formatCurrency(item.sell_price)} flat`;
        bodyElements.push(details);
      }

      const key = itemKey(type, item);
      button.textContent = key && state.selectedKeys.has(key) ? "Added" : "Add";
      button.disabled = key ? state.selectedKeys.has(key) : false;
      button.addEventListener("click", () => addLine(type, item));

      header.appendChild(title);
      header.appendChild(button);
      card.appendChild(header);
      bodyElements.forEach((element) => card.appendChild(element));

      container.appendChild(card);
    }
  };

  const renderLists = () => {
    const filtered = {
      time: applyFilters("time"),
      parts: applyFilters("parts"),
      flat: applyFilters("flat"),
    };
    renderList("time", filtered.time);
    renderList("parts", filtered.parts);
    renderList("flat", filtered.flat);
    updateMetrics(filtered);
  };

  const renderInvoice = () => {
    const hasLines = state.selectedLines.length > 0;
    els.invoiceEmpty.style.display = hasLines ? "none" : "block";
    els.invoiceTable.style.display = hasLines ? "table" : "none";
    els.invoiceLines.innerHTML = "";

    if (!hasLines) {
      els.finalizeGroup.classList.add("hidden");
      els.statusMessage.textContent = "";
      els.subtotal.textContent = "$0.00";
      els.total.textContent = "$0.00";
      return;
    }

    state.selectedLines.forEach((line, index) => {
      const row = document.createElement("tr");
      const itemCell = document.createElement("td");
      itemCell.className = "invoice-item";
      const qtyCell = document.createElement("td");
      qtyCell.className = "invoice-qty";
      const rateCell = document.createElement("td");
      rateCell.className = "invoice-rate";
      const totalCell = document.createElement("td");
      totalCell.className = "invoice-total";
      const actionCell = document.createElement("td");
      actionCell.className = "table-actions";

      const qtyInput = document.createElement("input");
      qtyInput.type = "number";
      qtyInput.step = "0.01";
      qtyInput.value = line.qty;

      const rateInput = document.createElement("input");
      rateInput.type = "number";
      rateInput.step = "0.01";
      rateInput.value = line.unit_price;

      const removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.className = "btn btn-link";
      removeButton.textContent = "Remove";

      qtyInput.addEventListener("change", () => {
        const value = Number(qtyInput.value);
        line.qty = Number.isFinite(value) && value >= 0 ? value : line.qty;
        renderInvoice();
      });

      rateInput.addEventListener("change", () => {
        const value = Number(rateInput.value);
        line.unit_price = Number.isFinite(value) ? value : line.unit_price;
        renderInvoice();
      });

      removeButton.addEventListener("click", () => {
        state.selectedLines.splice(index, 1);
        state.selectedKeys.delete(`${line.source_type}:${line.source_id}`);
        renderLists();
        renderInvoice();
      });

      itemCell.textContent = line.description;
      qtyCell.appendChild(qtyInput);
      rateCell.appendChild(rateInput);
      totalCell.textContent = formatCurrency(Number(line.qty) * Number(line.unit_price));
      actionCell.appendChild(removeButton);
      row.appendChild(itemCell);
      row.appendChild(qtyCell);
      row.appendChild(rateCell);
      row.appendChild(totalCell);
      row.appendChild(actionCell);
      els.invoiceLines.appendChild(row);
    });

    const discount = Number(els.discountInput.value) || 0;
    const tax = Number(els.taxInput.value) || 0;

    let subtotal = state.selectedLines.reduce((sum, line) => sum + Number(line.qty) * Number(line.unit_price), 0);
    subtotal -= discount;
    const total = subtotal + tax;

    els.subtotal.textContent = formatCurrency(subtotal);
    els.total.textContent = formatCurrency(total);

    els.finalizeGroup.classList.toggle("hidden", !state.currentInvoice);
  };

  const addLine = (type, item) => {
    const key = itemKey(type, item);
    if (!key || state.selectedKeys.has(key)) {
      return;
    }
    const line = {
      line_type: "flat",
      description: "",
      qty: 1,
      unit_price: 0,
      source_type: "flat_task",
      source_id: null,
    };
    if (type === "time") {
      const hours = (Number(item.minutes) || 0) / 60;
      line.line_type = "labor";
      line.source_type = item.source_type || "time_entry";
      line.source_id = item.source_id ?? item.time_entry_id;
      line.description = item.description || `Time Entry #${item.time_entry_id}`;
      line.qty = hours || 1;
      line.unit_price = parseFloat(item.resolved_bill_rate) || 0;
    } else if (type === "parts") {
      line.line_type = "part";
      line.source_type = item.source_type || "part_usage";
      line.source_id = item.source_id ?? item.part_usage_id;
      line.description = `${item.name} (${item.sku})`;
      line.qty = Number(item.qty) || 1;
      line.unit_price = parseFloat(item.resolved_sell_price) || 0;
    } else {
      line.line_type = "flat";
      line.source_type = item.source_type || "flat_task";
      line.source_id = item.source_id ?? item.catalog_item_id;
      line.description = item.name;
      line.qty = 1;
      line.unit_price = parseFloat(item.sell_price) || 0;
    }
    if (typeof line.source_id === "string") {
      const numeric = Number(line.source_id);
      if (!Number.isNaN(numeric)) {
        line.source_id = numeric;
      }
    }
    state.selectedLines.push(line);
    state.selectedKeys.add(key);
    state.currentInvoice = null;
    renderLists();
    renderInvoice();
  };

  const setActiveTab = (tab) => {
    state.activeTab = tab;
    els.tabs.forEach((tabBtn) => {
      const isActive = tabBtn.dataset.tab === tab;
      tabBtn.classList.toggle("active", isActive);
      tabBtn.setAttribute("aria-selected", String(isActive));
    });
    els.panels.forEach((panel) => {
      panel.classList.toggle("hidden", panel.dataset.list !== tab);
    });
  };

  const loadUnbilled = async () => {
    const params = new URLSearchParams();
    if (state.selectedClientId) {
      params.set("client_id", state.selectedClientId);
    }
    els.statusMessage.textContent = "Loading unbilled items…";
    try {
      const response = await fetch(`/api/v2/billing/unbilled?${params.toString()}`, {
        credentials: "same-origin",
      });
      if (!response.ok) {
        throw new Error(`Request failed: ${response.status}`);
      }
      state.unbilled = await response.json();
      updateProjectOptions();
      renderLists();
      els.statusMessage.textContent = "";
    } catch (error) {
      console.error("Failed to load unbilled items", error);
      els.statusMessage.textContent = "Unable to load unbilled items.";
    }
  };

  const createInvoice = async () => {
    if (!state.selectedLines.length) {
      els.statusMessage.textContent = "Select at least one line item.";
      return;
    }
    if (!state.selectedClientId) {
      els.statusMessage.textContent = "Choose a client before creating an invoice.";
      return;
    }
    const discount = parseFloat(els.discountInput.value) || 0;
    const tax = parseFloat(els.taxInput.value) || 0;
    const lines = state.selectedLines.map((line) => ({
      line_type: line.line_type,
      description: line.description,
      qty: Number(line.qty),
      unit_price: Number(line.unit_price),
      source_type: line.source_type,
      source_id: line.source_id,
    }));
    if (discount > 0) {
      lines.push({
        line_type: "flat",
        description: "Discount",
        qty: 1,
        unit_price: -discount,
        source_type: "flat_task",
        source_id: null,
      });
    }
    const payload = {
      client_id: state.selectedClientId,
      lines,
      tax,
    };
    els.statusMessage.textContent = "Creating draft invoice…";
    try {
      const response = await fetch("/api/v2/billing/invoices", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText || "Failed to create invoice");
      }
      const invoice = await response.json();
      state.currentInvoice = invoice;
      els.statusMessage.textContent = `Draft invoice #${invoice.id} created.`;
      els.finalizeGroup.classList.remove("hidden");
      await loadUnbilled();
    } catch (error) {
      console.error("Failed to create invoice", error);
      els.statusMessage.textContent = "Unable to create invoice; check selections and try again.";
    }
  };

  const finalizeInvoice = async () => {
    if (!state.currentInvoice) {
      els.statusMessage.textContent = "Create an invoice draft first.";
      return;
    }
    const status = els.finalizeStatus.value || "sent";
    els.statusMessage.textContent = "Finalizing invoice…";
    try {
      const response = await fetch(`/api/v2/billing/invoices/${state.currentInvoice.id}/finalize`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ status }),
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText || "Finalize failed");
      }
      const invoice = await response.json();
      els.statusMessage.textContent = `Invoice #${invoice.id} marked as ${invoice.status}.`;
      state.currentInvoice = invoice;
      await loadUnbilled();
    } catch (error) {
      console.error("Failed to finalize invoice", error);
      els.statusMessage.textContent = "Unable to finalize invoice.";
    }
  };

  const resetBuilder = () => {
    state.selectedLines = [];
    state.selectedKeys.clear();
    state.currentInvoice = null;
    els.discountInput.value = "0.00";
    els.taxInput.value = "0.00";
    els.statusMessage.textContent = "Selection cleared.";
    renderLists();
    renderInvoice();
  };

  const clearFilters = () => {
    if (els.clientSelect) {
      els.clientSelect.value = "";
    }
    if (els.projectSelect) {
      els.projectSelect.value = "";
    }
    if (els.fromInput) {
      els.fromInput.value = "";
    }
    if (els.toInput) {
      els.toInput.value = "";
    }
    state.selectedClientId = null;
    state.filters = { projectId: "", from: "", to: "" };
    updateSelectionIndicator();
    loadUnbilled();
  };

  els.tabs.forEach((tabBtn) => {
    tabBtn.addEventListener("click", () => {
      setActiveTab(tabBtn.dataset.tab);
    });
  });

  els.filtersForm.addEventListener("submit", (event) => {
    event.preventDefault();
    state.selectedClientId = els.clientSelect.value ? Number(els.clientSelect.value) : null;
    state.filters.projectId = els.projectSelect.value;
    state.filters.from = els.fromInput.value;
    state.filters.to = els.toInput.value;
    updateSelectionIndicator();
    loadUnbilled();
  });

  els.projectSelect.addEventListener("change", () => {
    state.filters.projectId = els.projectSelect.value;
    renderLists();
  });

  els.fromInput.addEventListener("change", () => {
    state.filters.from = els.fromInput.value;
    renderLists();
  });

  els.toInput.addEventListener("change", () => {
    state.filters.to = els.toInput.value;
    renderLists();
  });

  els.discountInput.addEventListener("change", renderInvoice);
  els.taxInput.addEventListener("change", renderInvoice);
  els.createButton.addEventListener("click", createInvoice);
  els.finalizeButton.addEventListener("click", finalizeInvoice);
  els.resetButton.addEventListener("click", resetBuilder);

  if (els.clearFiltersButton) {
    els.clearFiltersButton.addEventListener("click", (event) => {
      event.preventDefault();
      clearFilters();
    });
  }

  updateSelectionIndicator();
  updateProjectOptions();
  renderLists();
  renderInvoice();
  setActiveTab(state.activeTab);
})();
</script>
{% endblock %}
